"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function parseZoneFile(r){return r=removeComments(r),r=flatten(r),parseRRs(r)}function removeComments(r){const t=/(^|[^\\]);.*/g;return r.replace(t,function(e,n){return n||""})}function flatten(r){const t=[],e=/\([\s\S]*?\)/gim;let n=e.exec(r);for(;n!==null;){const i=n[0].replace(/\s+/gm," ");t.push({match:n,replacement:i}),n=e.exec(r)}const s=r.split("");for(const i of t){const{match:o,replacement:c}=i;s.splice(o.index,o[0].length,c)}return s.join("").replace(/\(|\)/gim," ")}function parseRRs(r){const t={},e=r.split(`
`);for(const n of e){if(!n||!n.trim())continue;const s=n.toUpperCase();/\s+TXT\s+/.test(s)?(t.txt=t.txt||[],t.txt.push(parseTXT(n))):s.indexOf("$ORIGIN")===0?t.$origin=n.split(/\s+/g)[1]:s.indexOf("$TTL")===0?t.$ttl=parseInt(n.split(/\s+/g)[1],10):/\s+SOA\s+/.test(s)?t.soa=parseSOA(n):/\s+NS\s+/.test(s)?(t.ns=t.ns||[],t.ns.push(parseNS(n))):/\s+A\s+/.test(s)?(t.a=t.a||[],t.a.push(parseA(n,t.a))):/\s+AAAA\s+/.test(s)?(t.aaaa=t.aaaa||[],t.aaaa.push(parseAAAA(n))):/\s+CNAME\s+/.test(s)?(t.cname=t.cname||[],t.cname.push(parseCNAME(n))):/\s+MX\s+/.test(s)?(t.mx=t.mx||[],t.mx.push(parseMX(n))):/\s+PTR\s+/.test(s)?(t.ptr=t.ptr||[],t.ptr.push(parsePTR(n,t.ptr,t.$origin))):/\s+SRV\s+/.test(s)?(t.srv=t.srv||[],t.srv.push(parseSRV(n))):/\s+SPF\s+/.test(s)?(t.spf=t.spf||[],t.spf.push(parseSPF(n))):/\s+URI\s+/.test(s)&&(t.uri=t.uri||[],t.uri.push(parseURI(n)))}return t}function parseSOA(r){const t={},e=r.trim().split(/\s+/g),n=e.length;return t.name=e[0],t.minimum=parseInt(e[n-1],10),t.expire=parseInt(e[n-2],10),t.retry=parseInt(e[n-3],10),t.refresh=parseInt(e[n-4],10),t.serial=parseInt(e[n-5],10),t.rname=e[n-6],t.mname=e[n-7],isNaN(e[1])||(t.ttl=parseInt(e[1],10)),t}function parseNS(r){const t=r.trim().split(/\s+/g),e=t.length,n={name:t[0],host:t[e-1]};return isNaN(t[1])||(n.ttl=parseInt(t[1],10)),n}function parseA(r,t){const e=r.trim().split(/\s+/g),n=r.trim().toUpperCase().split(/\s+/g),s=e.length,i={name:e[0],ip:e[s-1]};return n.lastIndexOf("A")===0&&(t.length?i.name=t[t.length-1].name:i.name="@"),isNaN(e[1])||(i.ttl=parseInt(e[1],10)),i}function parseAAAA(r){const t=r.trim().split(/\s+/g),e=t.length,n={name:t[0],ip:t[e-1]};return isNaN(t[1])||(n.ttl=parseInt(t[1],10)),n}function parseCNAME(r){const t=r.trim().split(/\s+/g),e=t.length,n={name:t[0],alias:t[e-1]};return isNaN(t[1])||(n.ttl=parseInt(t[1],10)),n}function parseMX(r){const t=r.trim().split(/\s+/g),e=t.length,n={name:t[0],preference:parseInt(t[e-2],10),host:t[e-1]};return isNaN(t[1])||(n.ttl=parseInt(t[1],10)),n}function parseTXT(r){const t=r.trim().match(/[^\s"']+|"[^"]*"|'[^']*'/g);if(!t)throw new Error("Failure to tokenize TXT record");const e=t.length,n=t.indexOf("TXT");function s(c){return c.indexOf('"')>-1&&(c=c.split('"')[1]),c}let i;e-n-1>1?i=[...t.slice(n+1).map(s)]:i=s(t[e-1]);const o={name:t[0],txt:i};return isNaN(t[1])||(o.ttl=parseInt(t[1],10)),o}function parsePTR(r,t,e){const n=r.trim().split(/\s+/g);r.trim().toUpperCase().split(/\s+/g).lastIndexOf("PTR")===0&&t[t.length-1]&&n.unshift(t[t.length-1].name);const i=n.length,o={name:n[0],fullname:`${n[0]}.${e}`,host:n[i-1]};return isNaN(n[1])||(o.ttl=parseInt(n[1],10)),o}function parseSRV(r){const t=r.trim().split(/\s+/g),e=t.length,n={name:t[0],target:t[e-1],priority:parseInt(t[e-4],10),weight:parseInt(t[e-3],10),port:parseInt(t[e-2],10)};return isNaN(t[1])||(n.ttl=parseInt(t[1],10)),n}function parseSPF(r){const t=r.trim().split(/\s+/g),e={name:t[0],data:""};let n=t.length;for(;n-- >4;)e.data=t[n]+" "+e.data.trim();return isNaN(t[1])||(e.ttl=parseInt(t[1],10)),e}function parseURI(r){const t=r.trim().split(/\s+/g),e=t.length,n={name:t[0],target:t[e-1].replace(/"/g,""),priority:parseInt(t[e-3],10),weight:parseInt(t[e-2],10)};return isNaN(t[1])||(n.ttl=parseInt(t[1],10)),n}function getZoneFileTemplate(){return`{$origin}
{$ttl}

; SOA Record
{name} {ttl}    IN  SOA {mname}{rname}(
{serial} ;serial
{refresh} ;refresh
{retry} ;retry
{expire} ;expire
{minimum} ;minimum ttl
)

; NS Records
{ns}

; MX Records
{mx}

; A Records
{a}

; AAAA Records
{aaaa}

; CNAME Records
{cname}

; PTR Records
{ptr}

; TXT Records
{txt}

; SRV Records
{srv}

; SPF Records
{spf}

; URI Records
{uri}
`}function makeProfileZoneFile(r,t){if(!t.includes("://"))throw new Error("Invalid token file url");const e=t.split("://")[0],n=t.split("://")[1].split("/"),s=n[0],i=`/${n.slice(1).join("/")}`,o={$origin:r,$ttl:3600,uri:[{name:"_http._tcp",priority:10,weight:1,target:`${e}://${s}${i}`}]};return makeZoneFile(o,`{$origin}
{$ttl}
{uri}
`)}function makeZoneFile(r,t=getZoneFileTemplate()){return t=processOrigin(r.$origin,t),t=processTTL(r.$ttl,t),t=processSOA(r.soa,t),t=processNS(r.ns,t),t=processA(r.a,t),t=processAAAA(r.aaaa,t),t=processCNAME(r.cname,t),t=processMX(r.mx,t),t=processPTR(r.ptr,t),t=processTXT(r.txt,t),t=processSRV(r.srv,t),t=processSPF(r.spf,t),t=processURI(r.uri,t),t=processValues(r,t),t.replace(/\n{2,}/gim,`

`)}function processOrigin(r,t){let e="";return typeof r!="undefined"&&(e+="$ORIGIN "+r),t.replace("{$origin}",e)}function processTTL(r,t){let e="";return typeof r!="undefined"&&(e+="$TTL "+r),t.replace("{$ttl}",e)}function processSOA(r,t){let e=t;if(typeof r!="undefined"){r.name=r.name||"@",r.ttl=r.ttl||"";for(const n in r){const s=r[n];e=e.replace("{"+n+"}",s+"	")}}return e}function processNS(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	NS	"+n.host+`
`;return t.replace("{ns}",e)}function processA(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	A	"+n.ip+`
`;return t.replace("{a}",e)}function processAAAA(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	AAAA	"+n.ip+`
`;return t.replace("{aaaa}",e)}function processCNAME(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	CNAME	"+n.alias+`
`;return t.replace("{cname}",e)}function processMX(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	MX	"+n.preference+"	"+n.host+`
`;return t.replace("{mx}",e)}function processPTR(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	PTR	"+n.host+`
`;return t.replace("{ptr}",e)}function processTXT(r,t){let e="";if(r)for(const n of r){e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	TXT	";const s=n.txt;typeof s=="string"?e+='"'+s+'"':s instanceof Array&&(e+=s.map(function(i){return'"'+i+'"'}).join(" ")),e+=`
`}return t.replace("{txt}",e)}function processSRV(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	SRV	"+n.priority+"	",e+=n.weight+"	",e+=n.port+"	",e+=n.target+`
`;return t.replace("{srv}",e)}function processSPF(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	SPF	"+n.data+`
`;return t.replace("{spf}",e)}function processURI(r,t){let e="";if(r)for(const n of r)e+=(n.name||"@")+"	",n.ttl&&(e+=n.ttl+"	"),e+="IN	URI	"+n.priority+"	",e+=n.weight+"	",e+='"'+n.target+`"
`;return t.replace("{uri}",e)}function processValues(r,t){t=t.replace("{zone}",r.$origin||(r.soa?r.soa.name:!1)||""),t=t.replace("{datetime}",new Date().toISOString());const e=Math.round(Date.now()/1e3);return t.replace("{time}",`${e}`)}exports.getZoneFileTemplate=getZoneFileTemplate,exports.makeProfileZoneFile=makeProfileZoneFile,exports.makeZoneFile=makeZoneFile,exports.parseZoneFile=parseZoneFile;
