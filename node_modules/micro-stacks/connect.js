"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var common=require("micro-stacks/common"),crypto=require("micro-stacks/crypto"),clarity=require("micro-stacks/clarity"),transactions=require("micro-stacks/transactions");const IS_BROWSER=typeof document!="undefined";exports.PersistedDataKeys=void 0,function(e){e.SessionStorageKey="stacks-session",e.NetworkStorageKey="stacks-network"}(exports.PersistedDataKeys||(exports.PersistedDataKeys={}));const _localStorage=common.getGlobalObject("localStorage",{returnEmptyObject:!0}),defaultStorageAdapter={setItem:(e,t)=>{if(IS_BROWSER)return _localStorage==null?void 0:_localStorage.setItem(e,t)},getItem:e=>{if(IS_BROWSER){const t=_localStorage==null?void 0:_localStorage.getItem(e);if(t===null)throw new Error("defaultStorageAdapter: no value stored");return t}},removeItem:e=>{if(IS_BROWSER)return _localStorage==null?void 0:_localStorage.removeItem(e)}};function getOrFormatPostConditions(e){return e==null?void 0:e.map(t=>typeof t!="string"?common.bytesToHex(transactions.serializePostCondition(t)):t)}var __defProp$3=Object.defineProperty,__defProps$3=Object.defineProperties,__getOwnPropDescs$3=Object.getOwnPropertyDescriptors,__getOwnPropSymbols$3=Object.getOwnPropertySymbols,__hasOwnProp$3=Object.prototype.hasOwnProperty,__propIsEnum$3=Object.prototype.propertyIsEnumerable,__defNormalProp$3=(e,t,r)=>t in e?__defProp$3(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__spreadValues$3=(e,t)=>{for(var r in t||(t={}))__hasOwnProp$3.call(t,r)&&__defNormalProp$3(e,r,t[r]);if(__getOwnPropSymbols$3)for(var r of __getOwnPropSymbols$3(t))__propIsEnum$3.call(t,r)&&__defNormalProp$3(e,r,t[r]);return e},__spreadProps$3=(e,t)=>__defProps$3(e,__getOwnPropDescs$3(t));const signTransactionPayload=async(e,t)=>new crypto.TokenSigner("ES256k",t).sign(__spreadProps$3(__spreadValues$3({},e),{postConditions:getOrFormatPostConditions(e.postConditions)}));exports.TransactionTypes=void 0,function(e){e.ContractCall="contract_call",e.ContractDeploy="smart_contract",e.STXTransfer="token_transfer"}(exports.TransactionTypes||(exports.TransactionTypes={}));var __defProp$2=Object.defineProperty,__defProps$2=Object.defineProperties,__getOwnPropDescs$2=Object.getOwnPropertyDescriptors,__getOwnPropSymbols$2=Object.getOwnPropertySymbols,__hasOwnProp$2=Object.prototype.hasOwnProperty,__propIsEnum$2=Object.prototype.propertyIsEnumerable,__defNormalProp$2=(e,t,r)=>t in e?__defProp$2(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__spreadValues$2=(e,t)=>{for(var r in t||(t={}))__hasOwnProp$2.call(t,r)&&__defNormalProp$2(e,r,t[r]);if(__getOwnPropSymbols$2)for(var r of __getOwnPropSymbols$2(t))__propIsEnum$2.call(t,r)&&__defNormalProp$2(e,r,t[r]);return e},__spreadProps$2=(e,t)=>__defProps$2(e,__getOwnPropDescs$2(t)),__objRest$2=(e,t)=>{var r={};for(var o in e)__hasOwnProp$2.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(e!=null&&__getOwnPropSymbols$2)for(var o of __getOwnPropSymbols$2(e))t.indexOf(o)<0&&__propIsEnum$2.call(e,o)&&(r[o]=e[o]);return r};async function makeContractCallToken(e){var t=e,{functionArgs:r,privateKey:o}=t,n=__objRest$2(t,["functionArgs","privateKey"]);const a=common.bytesToHex(crypto.getPublicKey(o,!0)),i=__spreadProps$2(__spreadValues$2({},n),{functionArgs:r.map(s=>common.cleanHex(typeof s=="string"?s:clarity.cvToHex(s))),txType:exports.TransactionTypes.ContractCall,publicKey:a});return signTransactionPayload(i,o)}var __defProp$1=Object.defineProperty,__defProps$1=Object.defineProperties,__getOwnPropDescs$1=Object.getOwnPropertyDescriptors,__getOwnPropSymbols$1=Object.getOwnPropertySymbols,__hasOwnProp$1=Object.prototype.hasOwnProperty,__propIsEnum$1=Object.prototype.propertyIsEnumerable,__defNormalProp$1=(e,t,r)=>t in e?__defProp$1(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__spreadValues$1=(e,t)=>{for(var r in t||(t={}))__hasOwnProp$1.call(t,r)&&__defNormalProp$1(e,r,t[r]);if(__getOwnPropSymbols$1)for(var r of __getOwnPropSymbols$1(t))__propIsEnum$1.call(t,r)&&__defNormalProp$1(e,r,t[r]);return e},__spreadProps$1=(e,t)=>__defProps$1(e,__getOwnPropDescs$1(t)),__objRest$1=(e,t)=>{var r={};for(var o in e)__hasOwnProp$1.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(e!=null&&__getOwnPropSymbols$1)for(var o of __getOwnPropSymbols$1(e))t.indexOf(o)<0&&__propIsEnum$1.call(e,o)&&(r[o]=e[o]);return r};async function makeContractDeployToken(e){var t=e,{privateKey:r}=t,o=__objRest$1(t,["privateKey"]);const n=__spreadProps$1(__spreadValues$1({},o),{publicKey:common.bytesToHex(crypto.getPublicKey(r,!0)),txType:exports.TransactionTypes.ContractDeploy});return signTransactionPayload(n,r)}var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,r)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__spreadValues=(e,t)=>{for(var r in t||(t={}))__hasOwnProp.call(t,r)&&__defNormalProp(e,r,t[r]);if(__getOwnPropSymbols)for(var r of __getOwnPropSymbols(t))__propIsEnum.call(t,r)&&__defNormalProp(e,r,t[r]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__objRest=(e,t)=>{var r={};for(var o in e)__hasOwnProp.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(e!=null&&__getOwnPropSymbols)for(var o of __getOwnPropSymbols(e))t.indexOf(o)<0&&__propIsEnum.call(e,o)&&(r[o]=e[o]);return r};async function makeStxTransferToken(e){var t=e,{privateKey:r}=t,o=__objRest(t,["privateKey"]);const n=__spreadProps(__spreadValues({},o),{amount:typeof o.amount=="bigint"?Number(o.amount).toString(10):o.amount,publicKey:common.bytesToHex(crypto.getPublicKey(r,!0)),txType:exports.TransactionTypes.STXTransfer});return signTransactionPayload(n,r)}function getDIDType(e){const t=e.split(":");if(t.length!==3)throw new TypeError("Decentralized IDs must have 3 parts");if(t[0].toLowerCase()!=="did")throw new TypeError('Decentralized IDs must start with "did"');return t[1].toLowerCase()}function getAddressFromDID(e){return e&&getDIDType(e)==="btc-addr"?e.split(":")[2]:void 0}async function decodeAuthResponse(e,t){const r=crypto.decodeToken(e),n=r==null?void 0:r.payload,{private_key:a}=n,i=common.hexToJSON(a),s=await crypto.decryptECIES({privateKey:t,cipherObject:i});return{addresses:n.profile.stxAddress,appPrivateKey:s,associationToken:n.associationToken,hubUrl:n.hubUrl,public_keys:n.public_keys,profile:n.profile,profile_url:n.profile_url,username:n.username,version:n.version,decentralizedID:n.iss,identityAddress:getAddressFromDID(n.iss)}}function getStacksProvider(){return common.getGlobalObject("StacksProvider",{returnEmptyObject:!1,usageDesc:"authenticate",throwIfUnavailable:!0})}async function authenticate(e,t=defaultStorageAdapter,r=JSON.stringify){var o,n;if(!e.appDetails)throw Error("[micro-stacks] authenticate error: `authOptions.appDetails` are required for authentication");try{const a=common.bytesToHex(crypto.getRandomBytes()),i=await handleAuthResponse(e,a),s=await decodeAuthResponse(i,a);return(o=e==null?void 0:e.onFinish)==null||o.call(e,s),t.setItem(exports.PersistedDataKeys.SessionStorageKey,r(s)),s}catch(a){(n=e==null?void 0:e.onCancel)==null||n.call(e,a.message)}}function generateAuthRequestPayload(e,t){if(!e.appDetails)throw Error("[micro-stacks] authenticate error: `authOptions.appDetails` are required for authentication");const r=e.scopes||[],o=common.getGlobalObject("location",{returnEmptyObject:!0}).origin;return{scopes:[...new Set(["store_write",...r])],redirect_uri:o,public_keys:[t],domain_name:o,appDetails:e.appDetails}}async function signAuthRequest(e,t){return new crypto.TokenSigner("ES256k",t).sign(e)}async function generateSignedAuthRequest(e,t){const r=common.bytesToHex(crypto.getPublicKey(t)),o=generateAuthRequestPayload(e,r);return signAuthRequest(o,t)}async function handleAuthResponse(e,t){const r=getStacksProvider();if(!r)throw Error("This function can only be called on the client, and with the presence of StacksProvider");const o=await generateSignedAuthRequest(e,t);return r.authenticationRequest(o)}async function openTransactionPopup(e){const{token:t,onFinish:r,onCancel:o}=e;try{const a=await getStacksProvider().transactionRequest(t);r==null||r(a)}catch(n){console.error(n),o==null||o(n==null?void 0:n.message)}}async function openProfileUpdatePopup(e){const{token:t,onFinish:r,onCancel:o}=e;try{const n=getStacksProvider();n||console.error("no stacks provider");const a=await n.profileUpdateRequest(t);r==null||r(a)}catch(n){console.error(n),o==null||o(n==null?void 0:n.message)}}exports.IS_BROWSER=IS_BROWSER,exports.authenticate=authenticate,exports.decodeAuthResponse=decodeAuthResponse,exports.defaultStorageAdapter=defaultStorageAdapter,exports.generateAuthRequestPayload=generateAuthRequestPayload,exports.generateSignedAuthRequest=generateSignedAuthRequest,exports.getAddressFromDID=getAddressFromDID,exports.getDIDType=getDIDType,exports.handleAuthResponse=handleAuthResponse,exports.makeContractCallToken=makeContractCallToken,exports.makeContractDeployToken=makeContractDeployToken,exports.makeStxTransferToken=makeStxTransferToken,exports.openProfileUpdatePopup=openProfileUpdatePopup,exports.openTransactionPopup=openTransactionPopup,exports.signAuthRequest=signAuthRequest;
